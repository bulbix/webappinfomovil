var server=requestServer("POST",contextPath+"/infomovil/getPerfil",{}).perfil,contactos={getUrl:server+"/api/editorVolante/getContacto",delUrl:server+"/api/editorVolante/deleteContacto",saveUrl:server+"api/editorVolante/upsertContacto"};app.factory("VolanteService",function($http,MensajesService){function getVolantes(callback){$http({method:"GET",url:contextPath+"/infomovil/getPromociones"}).then(function(response){volantes=response.data,totVolantes=volantes.length,nombreVolante=response.data.nombreSitio,banderaCanal=response.data.banderaCanal,totVolantes>0&&void 0!=totVolantes?($(".muestraPromoPublicada").css("display","block"),$(".muestraPublicarPromo").css("display","none")):($(".muestraPublicarPromo").css("display","block"),$(".muestraPromoPublicada").css("display","none")),getContactosVolantes(),null!=callback&&callback()},function(response){var mensaje="No se ha podido obtener la lista de volantes";MensajesService.cerrarBlockUIGeneral("Contactos",mensaje)})}function getVolantesPublicar(callback){$http({method:"GET",url:contextPath+"/infomovil/getPromociones"}).then(function(response){$("#idPromocion").text(response.data[0].idOffer),$("#urlPromocion").text(response.data[0].urlPromocion),$("#tempPromocion").text(response.data[0].template),getContactosVolantes()},function(response){var mensaje="No se ha podido obtener la lista de volantes";MensajesService.cerrarBlockUIGeneral("Contactos",mensaje)})}function actualizarVolante(volante,evento,callback){var mensaje="Actualizando volante...";MensajesService.abrirBlockUIGeneral(mensaje),$http({method:"POST",url:contextPath+"/infomovil/guardarPromocion",params:{titulo:volante.nombrePromo,descripcion:volante.descPromo,fechaVigencia:volante.datepickerPromo,base64Imagen:"",redimir:volante.redimir,terminos:volante.infoadiPromo,templatePromo:volante.plantillaPromo,idPromocion:volante.idPromocion,empresa:volante.empresa,nombreVolante:volante.nombreVolante}}).then(function(response){MensajesService.cerrarBlockUIGeneral("Volantes",""),$("#myModalTempPromo").modal("hide"),getVolantesPublicar(),guardarEventoGA(evento,response.data.nombreSitio,response.data.banderaCanal),null!=callback&&callback()},function(response){mensaje="No se ha podido actualizar el contacto",MensajesService.cerrarBlockUIGeneral("Volantes",mensaje)})}function guardarEventoGA(nombreEvento,nombreSitio,banderaCanal){ga("send","event","promo",nombreEvento,nombreSitio,banderaCanal)}function getContactosVolantes(){var url=contactos.getUrl,offerID=getOfferId(),hash=hashUsuario();offerID.offerId>0&&(edatos={offerId:offerID.offerId,hashUser:hash},$http({method:"GET",url:url,params:edatos,async:!0}).then(function(response){for(i=0;i<response.data.contacto.length;i++)"E2U+voice:tel"==response.data.contacto[i].services?($("#telContactoVolante").val(response.data.contacto[i].contenido),$("#idTelContactoVolante").text(response.data.contacto[i].contactoId)):"E2U+voice:tel+x-mobile"==response.data.contacto[i].services?($("#celContactoVolante").val(response.data.contacto[i].contenido),$("#idCelContactoVolante").text(response.data.contacto[i].contactoId)):"E2U+email:mailto"==response.data.contacto[i].services&&($("#emailContactoVolante").val(response.data.contacto[i].contenido),$("#idEmailContactoVolante").text(response.data.contacto[i].contactoId));$("#nombreEmpresaPromo").val(datos.empresa)},function(response){}))}function getOfferId(){var resp=requestServer("POST",contextPath+"/infomovil/getPromociones",{});return datos=void 0!=resp[0]?{offerId:resp[0].idOffer,empresa:resp[0].empresa,pagina:resp[0].pagina}:{offerId:"",empresa:"",pagina:""}}var volantes,totVolantes,banderaCanal,nombreVolante,datos={},eliminarContactoVolante=function(tipoContacto){var url=contactos.delUrl,valContacto=0;"tel"==tipoContacto&&$("#idTelContactoVolante").text().length>0?valContacto=$("#idTelContactoVolante").text():"cel"==tipoContacto&&$("#idCelContactoVolante").text().length>0?valContacto=$("#idCelContactoVolante").text():"email"==tipoContacto&&$("#idEmailContactoVolante").text().length>0&&(valContacto=$("#idEmailContactoVolante").text());var hasha=hashUsuario(),delContacto={contactoId:valContacto,hashUser:hasha};$http({method:"DELETE",headers:{"Content-Type":"application/json"},url:url,data:delContacto}).then(function(response){"tel"==tipoContacto&&$("#idTelContactoVolante").text().length>0?valContacto=$("#idTelContactoVolante").text(""):"cel"==tipoContacto&&$("#idCelContactoVolante").text().length>0?valContacto=$("#idCelContactoVolante").text(""):"email"==tipoContacto&&$("#idEmailContactoVolante").text().length>0&&(valContacto=$("#idEmailContactoVolante").text("")),requestServer("GET",contextPath+"/infomovil/refrescarPromocion",{})},function(response){})};return{getContactosVolantes:getContactosVolantes,getVolantes:getVolantes,guardarEventoGA:guardarEventoGA,eliminarContactoVolante:eliminarContactoVolante,getVolantesPublicar:getVolantesPublicar,volantes:function(){return volantes},actualizarVolante:actualizarVolante,getOfferId:getOfferId,nombreVolante:function(){return nombreVolante},banderaCanal:function(){return banderaCanal},getTotVolantes:function(){return totVolantes}}});