function generarSliderPromo(){var urlRecurso="",slider="",li="";for(slider="<ul class='bxslider'>",i=0;i<templatesPromo.length;i+=1)urlRecurso="https://s3-us-west-2.amazonaws.com/promo.mobileinfo.io/templates/"+templatesPromo[i]+"/"+templatesPromo[i]+".png",li="<li class='text-center'><img style='width:100%; height:auto; min-width:280px!important; max-width:600px !important; max-height:661px!important;min-height:265px!important; display:block;' src='"+urlRecurso+"' title='"+nombresPromo[i]+"'' /></li>",slider+=li,urlRecurso="";$("#modalTempPromo").html("<div id='myModalTempPromo' class='modal fade' tabindex='-1' role='dialog' aria-labelledby='myModalLabel' aria-hidden='true'><div class='modal-dialog modal-md'><div class='modal-content'><div class='modal-header'><button type='button' class='close textBlack pull-left' data-dismiss='modal' aria-label='Close'><span aria-hidden='true'>&times;</span></button> <button type='button' class='btn btn-purple pull-right txtBtnEditor' onClick='actualizaEstiloPromo()'>Aplicar estilo</button></div><div class='modal-body'>"+slider+"</div><div class='modal-footer'></div></div></div></div>");var slider=$(".bxslider").bxSlider({moveSlides:1,displaySlideQty:2,responsive:!1,adaptiveHeight:!0,mode:"fade",captions:!0,pager:!0,touchEnabled:!0,useCSS:!1,onSlideAfter:function(){indicePromocion=slider.getCurrentSlide()}});$(document).on("click",".bx-next",function(){indicePromocion=slider.getCurrentSlide()}),$(document).on("click",".bx-prev",function(){indicePromocion=slider.getCurrentSlide()}),$(document).on("click",".bx-pager-link",function(){indicePromocion=slider.getCurrentSlide()})}function actualizaEstiloPromo(){plantillaPromo=templatesPromo[indicePromocion],$("#btnVistaPrevia").is(":visible")?($("#myModalTempPromo").modal("hide"),$("#tempPromocion").val(plantillaPromo),$.blockUI.defaults.baseZ=9e3,$.blockUI({message:"Actualizando plantilla promo...",css:{"class":"alertaUI",top:($(window).height()-400)/2+"px",left:($(window).width()-400)/2+"px",width:"400px"}}),setTimeout($.unblockUI,1e3)):($.blockUI.defaults.baseZ=9e3,$.blockUI({message:"Actualizando plantilla promo...",css:{"class":"alertaUI",top:($(window).height()-400)/2+"px",left:($(window).width()-400)/2+"px",width:"400px"}}),$.ajax({type:"POST",url:contextPath+"/infomovil/guardarPromocion",dataType:"json",data:{titulo:$nombrePromo.val(),descripcion:$descPromo.val(),fechaVigencia:$datepickerPromo.val(),base64Imagen:"",redimir:$(".radioPromo:checked").val(),terminos:$infoadiPromo.val(),templatePromo:plantillaPromo,idPromocion:$idPromocion.val()},success:function(data){$("#myModalTempPromo").modal("hide"),$("#tempPromocion").val(data.templatePromo),nombreSitio=data.nombreSitio,banderaCanal=data.banderaCanal,guardarEventoGA("promo-plantilla"),$.unblockUI()},error:function(json){$.unblockUI(),BootstrapDialog.show({title:"<span class='textBlack' style='font-size:1.15em;'><img alt='' src='../resources/webapp/images/fa-warning-bk.png'  title='Alerta' />No se han guardado los cambios</span>",message:'<div style="display:block; min-height:150px;"><p class="textBlack text-center" style="font-size:1.15em;">Por favor intentalo más tarde.</p><br/>'})}}))}function guardarEventoGA(nombreEvento){ga("send","event","promo",nombreEvento,nombreSitio,banderaCanal)}function getContactosVolantes(offerId,hashUser){var url=contactos.getUrl;$http({method:"GET",url:url+"?offerId="+offerId+"&hashUser="+hashUser}).then(function(response){contactosVolantes=response.data},function(response){var mensaje="No se ha podido obtener la lista de contactos";MensajesService.cerrarBlockUIGeneral("Contactos",mensaje)})}function eliminarContactoVolantes(contacto){var url=contactos.delUrl;$http({method:"POST",url:url,params:{contactoId:"",offerId:contacto.offerId,descripcion:contacto.descripcion,orderNaptr:contacto.orderNaptr,preference:contacto.preference,contenido:contacto.contenido,codigoPais:contacto.codigoPais,services:contacto.services,tipoContacto:contacto.tipoContacto,activo:contacto.activo,ultimaModificacion:contacto.ultimaModificacion,usuarioModifico:contacto.usuarioModifico,hashUser:hashUsuario()}}).then(function(response){response.data},function(response){var mensaje="No se ha podido obtener la lista de contactos";MensajesService.cerrarBlockUIGeneral("Contactos",mensaje)})}function getOfferId(){var offerId=0,resp=requestServer("POST",contextPath+"/infomovil/getPromociones",{});return void 0!=resp[0]&&(offerId=resp[0].idOffer),offerId}function getService(){return"+52"==$("#tipoTelefonoVolante option:selected").val()?"E2U+voice:tel":"E2U+voice:tel+x-mobile"}var $nombrePromo=$("#nombrePromo"),$descPromo=$("#descPromo"),$datepickerPromo=$("#datepicker"),$infoadiPromo=$("#infoadiPromo"),$divPromoPublicada=$("#divPromoPublicada"),$divPublicarPromo=$("#divPublicarPromo"),$idPromocion=$("#idPromocion"),$urlPromocion=$("#urlPromocion"),$divError=$("#divError"),$btnPublicar=$("#btnPublicar"),$btnVistaPrevia=$("#btnVistaPrevia"),$btnCompartir=$("#btnCompartir"),$btnVerPromo=$("#btnVerPromo"),$btnEliminar=$("#btnEliminar"),$btnGuardar=$("#btnGuardar"),templatesPromo=new Array("promo6","promo1","promo5","promo4","promo2","promo3"),nombresPromo=new Array("Cursos","Bares","Floral","Tecnología 2","Hipster","Tecnología"),plantillaPromo="promo1",indicePromocion=0,nombreSitio="",banderaCanal="",$btnVistaPreviaImprimirMovil=$("#btnImprimirPromoMovil"),$btnVistaPreviaImprimir=$("#btnImprimirPromo"),oldstrInner="",oldstr="",pathPDF="",pathJPG="",$urlVPPromoImprimir=$("#urlVistaPreviaPromoImprimir"),$getPromociones=function(){$.blockUI.defaults.baseZ=9e3,$.blockUI({message:"Obteniendo Promoción...",css:{"class":"alertaUI",top:($(window).height()-400)/2+"px",left:($(window).width()-400)/2+"px",width:"400px"}}),$.ajax({type:"POST",url:contextPath+"/infomovil/getPromociones",dataType:"json",success:function(data){data.length>0?($nombrePromo.val(data[0].titleOffer),$descPromo.val(data[0].descOffer),$infoadiPromo.val(data[0].termsOffer),$idPromocion.val(data[0].idOffer),$datepickerPromo.val(data[0].endDateOffer),$divPublicarPromo.hide(),$divPromoPublicada.show(),$activaRadio(data[0].redeemOffer)):($divPromoPublicada.hide(),$divPublicarPromo.show()),$.unblockUI()},error:function(json){$.unblockUI(),BootstrapDialog.show({title:"<span class='textBlack' style='font-size:1.15em;'><img alt='' src='../resources/webapp/images/fa-warning-bk.png'  title='Alerta' />No se ha eliminado la Promoción</span>",message:'<div style="display:block; min-height:150px;"><p class="textBlack text-center" style="font-size:1.15em;">Por favor intentalo más tarde.</p><br/>'})}})},$publicarPromocion=function(){var plantillaFinalPromo=$("#tempPromocion").val();plantillaFinalPromo.trim().length>0&&null!=plantillaFinalPromo&&(plantillaPromo=plantillaFinalPromo),$.blockUI.defaults.baseZ=9e3,$.blockUI({message:"Publicando promoción...",css:{"class":"alertaUI",top:($(window).height()-400)/2+"px",left:($(window).width()-400)/2+"px",width:"400px"}}),$.ajax({type:"POST",url:contextPath+"/infomovil/guardarPromocion",data:{titulo:$nombrePromo.val(),descripcion:$descPromo.val(),fechaVigencia:$datepickerPromo.val(),base64Imagen:"",redimir:$(".radioPromo:checked").val(),terminos:$infoadiPromo.val(),templatePromo:plantillaFinalPromo,idPromocion:$idPromocion.val(),empresa:"mi Empresa",nombreVolante:"juniorMan"},success:function(data){$divPublicarPromo.hide(),$divPromoPublicada.show(),$("#idPromocion").val(data.idOffer),$urlPromocion.val(data.urlPromocion),$urlVPPromoImprimir.attr("src",data.urlPromocion),$("#urlPromo").val(data.urlPromocion),nombreSitio=data.nombreSitio,banderaCanal=data.banderaCanal,$("#tempNombrePromo").val(data.nombreSitio),$("#tempBanderaPromo").val(data.banderaCanal),datosContacto=getContacto(),upsertContactoVolantes(datosContacto),guardarEventoGA("promo-publicar"),$.unblockUI()},error:function(json){$.unblockUI(),BootstrapDialog.show({title:"<span class='textBlack' style='font-size:1.15em;'><img alt='' src='../resources/webapp/images/fa-warning-bk.png'  title='Alerta' />No se ha publicado la Promoción</span>",message:'<div style="display:block; min-height:150px;"><p class="textBlack text-center" style="font-size:1.15em;">Por favor intentalo más tarde.</p><br/>'})}})},$guardarCambiosEnPromocion=function(){var plantillaFinalPromo=$("#tempPromocion").val();plantillaFinalPromo.trim().length>0&&null!=plantillaFinalPromo&&(plantillaPromo=plantillaFinalPromo),$.blockUI.defaults.baseZ=9e3,$.blockUI({message:"Guardando cambios...",css:{"class":"alertaUI",top:($(window).height()-400)/2+"px",left:($(window).width()-400)/2+"px",width:"400px"}}),$.ajax({type:"POST",url:contextPath+"/infomovil/guardarPromocion",dataType:"json",data:{titulo:$nombrePromo.val(),descripcion:$descPromo.val(),fechaVigencia:$datepickerPromo.val(),base64Imagen:"",redimir:$(".radioPromo:checked").val(),terminos:$infoadiPromo.val(),templatePromo:plantillaPromo,idPromocion:$idPromocion.val()},success:function(data){$divPublicarPromo.hide(),$divPromoPublicada.show(),$("#idPromocion").val(data.idOffer),$("#tempPromocion").val(data.templatePromo),nombreSitio=data.nombreSitio,banderaCanal=data.banderaCanal,guardarEventoGA("promo-guardar"),$.unblockUI()},error:function(json){$.unblockUI(),BootstrapDialog.show({title:"<span class='textBlack' style='font-size:1.15em;'><img alt='' src='../resources/webapp/images/fa-warning-bk.png'  title='Alerta' />No se han guardado los cambios</span>",message:'<div style="display:block; min-height:150px;"><p class="textBlack text-center" style="font-size:1.15em;">Por favor intentalo más tarde.</p><br/>'})}})},$eliminarPromocion=function(){BootstrapDialog.show({title:'<div class="textBlack">Eliminar</div>',message:'<div style="display:block; padding: 10px;">¿Seguro que deseas eliminar la promoción?</div>',buttons:[{label:"Cancelar",action:function(dialog){dialog.close()}},{label:"Aceptar",action:function(dialog){dialog.close(),$.blockUI.defaults.baseZ=9e3,$.blockUI({message:"Eliminando la promoción...",css:{"class":"alertaUI",top:($(window).height()-400)/2+"px",left:($(window).width()-400)/2+"px",width:"400px"}}),$.ajax({type:"POST",url:contextPath+"/infomovil/eliminarPromocion",dataType:"json",data:{idPromocion:$idPromocion.val()},success:function(data){$nombrePromo.val(""),$descPromo.val(""),$infoadiPromo.val(""),$idPromocion.val(""),$datepickerPromo.val(""),$urlPromocion.val(""),$divPublicarPromo.show(),$divPromoPublicada.hide(),$activaRadio("0"),templatePromo="promo1",$("#tempPromocion").val(""),nombreSitio=data.nombreSitio,banderaCanal=data.banderaCanal,guardarEventoGA("promo-eliminar"),$.unblockUI()},error:function(json){$.unblockUI(),BootstrapDialog.show({title:"<span class='textBlack' style='font-size:1.15em;'><img alt='' src='../resources/webapp/images/fa-warning-bk.png'  title='Alerta' />No se ha eliminado la Promoción</span>",message:'<div style="display:block; min-height:150px;"><p class="textBlack text-center" style="font-size:1.15em;">Por favor intentalo más tarde.</p><br/>'})}})}}]})},$compartirPromocion=function(){},$verPromocionActiva=function(){var $urlPromo=$("#urlPromocion").val();$urlPromo.trim().length>0&&null!=$urlPromo&&window.open($urlPromo,"_blank")},$vistaPrevia=function(){$.blockUI.defaults.baseZ=9e3,$.blockUI({message:"Generando vista previa...",css:{"class":"alertaUI",top:($(window).height()-400)/2+"px",left:($(window).width()-400)/2+"px",width:"400px"}}),$.ajax({type:"POST",url:contextPath+"/infomovil/verPromo",dataType:"json",data:{idDominio:0,titulo:$nombrePromo.val(),descripcion:$descPromo.val(),fechaVigencia:$datepickerPromo.val(),base64Imagen:"",redimir:$(".radioPromo:checked").val(),terminos:$infoadiPromo.val(),templatePromo:plantillaPromo,empresa:"mi Empresa"},success:function(data){$("#urlVistaPreviaPromo").attr("src",data.urlVistaPreviaPromo+"?vistaPrevia=1"),$("#myModalPromo").modal(),$.unblockUI()},error:function(json){$.unblockUI(),BootstrapDialog.show({title:"<span class='textBlack' style='font-size:1.15em;'><img alt='' src='../resources/webapp/images/fa-warning-bk.png'  title='Alerta' />No se ha podido obtener la vista previa de la Promoción</span>",message:'<div style="display:block; min-height:150px;"><p class="textBlack text-center" style="font-size:1.15em;">Por favor intentalo más tarde.</p><br/>'})}})},$activaRadio=function(radio){switch(radio){case"No especificado":$("#r1").prop("checked",!0);break;case"Llámanos":$("#r2").prop("checked",!0);break;case"Envíanos un e-mail":$("#r3").prop("checked",!0);break;case"Visítanos":$("#r4").prop("checked",!0);break;default:$("#r2#r3#r4").prop("checked",!1),$("#r1").prop("checked",!0)}},$validarCampos=function(){var $nom=$nombrePromo.val().trim(),$desc=$descPromo.val().trim(),$dp=$datepickerPromo.val(),$rp=$(".radioPromo:checked").val();return $nom.length<=0?"nombre de la promoción":$desc.length<=0?"descripción de la promoción":$dp.length<=0?"vigencia de la promoción":$rp.length<=0?"cómo redimir":"datosCompletos"};$(document).ready(function(){$btnPublicar.click(function(){$resultado=$validarCampos(),"datosCompletos"==$resultado?($divError.css("display","none"),$publicarPromocion()):($divError.html("Falta llenar el campo "+$resultado),$divError.css("display","block"))}),$btnVistaPrevia.click(function(){$vistaPrevia()}),$btnVistaPreviaImprimir.click(function(){$vistaPreviaImprimir()}),$btnVistaPreviaImprimirMovil.click(function(){$vistaPreviaImprimir()}),$btnCompartir.click(function(){var url=$("#urlPromocion").val(),lFace="http://www.facebook.com/sharer/sharer.php?u="+url+"&t=Checa%20esta%20promo%20";$("#Facebook").attr("href",lFace);var lGoogle="https://plus.google.com/share?url="+url;$("#Google").attr("href",lGoogle);var lEmail="mailto:?subject="+url+"%20Checa%20esta%20promo!&body=Checa%20esta%20promo:%20"+url+"%0A%0ACrea%20un%20volante%20digital%20asi%20con%20www.infomovil.com%0A%0A";$("#Email").attr("href",lEmail);var lTwitt="http://www.twitter.com/intent/tweet?text="+url+"%20%0A%0ACheca%20esta%20promo:%20"+url;if($("#Twitter").attr("href",lTwitt),navigator.userAgent.match(/Android|BlackBerry|iPhone|iPad|iPod|Opera Mini|IEMobile/i))var lWhatsapp="whatsapp://send?text=Checa%20esta%20promo:%20"+url;else var lWhatsapp="javascript:alert('Esta acción no se puede completar en este dispositivo')";$("#WhatsApp").attr("href",lWhatsapp),$compartirPromocion()}),$btnVerPromo.click(function(){$verPromocionActiva()}),$btnEliminar.click(function(){$eliminarPromocion()}),$btnGuardar.click(function(){$resultado=$validarCampos(),"datosCompletos"==$resultado?($("#divError").val(""),$("#divError").css("display","none"),$guardarCambiosEnPromocion()):($divError.text("Falta llenar el campo "+$resultado),$("#divError").css("display","block"))})});var $vistaPreviaImprimir=function(){$.blockUI.defaults.baseZ=9e3,$.blockUI({message:"Actualizando plantilla promo...",css:{"class":"alertaUI",top:($(window).height()-400)/2+"px",left:($(window).width()-400)/2+"px",width:"400px"}});var iframe=document.getElementById("urlVistaPreviaPromoImprimir");iframe.src=iframe.src+(new Date).getTime()+Math.floor(1e6*Math.random()),iframe.src=iframe.src,document.getElementById("urlVistaPreviaPromoImprimir").onload=function(){$.unblockUI(),$("#myModalPromoImprimir").modal()}},imprimirPromocionWeb=function(){oldstrInner=document.documentElement.innerHTML,oldstr=document.body.innerHTML,$.blockUI.defaults.baseZ=9e3,$.blockUI({message:"Generando impresión...",css:{"class":"alertaUI",top:($(window).height()-400)/2+"px",left:($(window).width()-400)/2+"px",width:"400px"}});var nombrePromocion=$("#tempNombrePromo").val()+".html";$.ajax({type:"POST",url:contextPath+"/infomovil/getHTMLPromocion",data:{nombrePromocion:nombrePromocion},success:function(data){$("#myModalPromoImprimir").modal("toggle"),document.documentElement.innerHTML=data.elHtmlDePromocion,imprimirPromocionEnPantalla(data.elHtmlDePromocion)},error:function(json){$.unblockUI(),BootstrapDialog.show({title:"<span class='textBlack' style='font-size:1.15em;'><img alt='' src='../resources/webapp/images/fa-warning-bk.png'  title='Alerta' />No se ha generado la impresión</span>",message:'<div style="display:block; min-height:150px;"><p class="textBlack text-center" style="font-size:1.15em;">Por favor intentalo más tarde.</p><br/>'})}})},imprimirPromocionEnPantalla=function(datahtml){setTimeout(function(){window.print(),window.focus(),window.close(),document.documentElement.innerHTML=oldstrInner,$(document.body).html(oldstr),$("#myModalPromoImprimir").modal(),$.unblockUI()},2500),ga("send","event","promo","promo-imprimir",$("#tempNombrePromo").val(),$("#tempBanderaPromo").val())},descargarPDF=function(){pathPDF=$("#urlVistaPreviaPromoImprimir").attr("src"),pathPDF=pathPDF.replace("html","pdf");var link=document.createElement("a");link.download="promo.pdf",link.href=pathPDF,link.click(),ga("send","event","promo","promo-guardarPDF",$("#tempNombrePromo").val(),$("#tempBanderaPromo").val())},descargarJPG=function(){pathJPG=$("#urlVistaPreviaPromoImprimir").attr("src"),pathJPG=pathJPG.replace("html","jpg");var link=document.createElement("a");link.download="promo.jpg",link.href=pathJPG,link.click(),ga("send","event","promo","promo-guardarJPG",$("#tempNombrePromo").val(),$("#tempBanderaPromo").val())},upsertContactoVolantes=function(contacto){var url=contactos.saveUrl;$http({method:"POST",url:url,params:{contactoId:contacto.id,offerId:contacto.offerId,descripcion:contacto.descripcion,orderNaptr:contacto.orderNaptr,preference:contacto.preference,contenido:contacto.contenido,codigoPais:contacto.codigoPais,services:contacto.services,tipoContacto:contacto.tipoContacto,activo:contacto.activo,ultimaModificacion:contacto.ultimaModificacion,usuarioModifico:contacto.usuarioModifico,hashUser:contacto.hashUser}}).then(function(response){response.data},function(response){var mensaje="No se ha podido obtener la lista de contactos";MensajesService.cerrarBlockUIGeneral("Contactos",mensaje)})},getContacto=function(){var contacto={contactoId:$("#idContactoVolante").val(),offerId:getOfferId(),descripcion:"",orderNaptr:"",preference:"0",contenido:$("#telefonoVolante").val(),codigoPais:$("#tipoTelefonoVolante option:selected").val(),services:getService(),tipoContacto:"tel:",activo:"1",ultimaModificacion:"",usuarioModifico:"",hashUser:hashUsuario()};return contacto};